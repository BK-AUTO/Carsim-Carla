import numpy as np

class BrakingModel:
    """
    Braking System Model with Regenerative and Mechanical Braking
    Based on Simulink block diagrams
    """
    
    def __init__(self, 
                 vehicle_mass=2530,           # kg - Vehicle mass
                 wheelbase_length=2.875,      # m - Wheelbase length  
                 cg_height=0.540,             # m - Center of gravity height
                 tire_radius=0.365,           # m - Tire radius
                 gear_ratio_hs=10.4180,           # Gear ratio high speed
                 inertia_wheel_front=1.5,     # kg*m² - Front wheel inertia
                 inertia_wheel_rear=1.5,      # kg*m² - Rear wheel inertia
                 regen_efficiency=0.927,      # Regenerative braking efficiency
                 **kwargs):                   # Accept additional parameters
        
        self.vehicle_mass = vehicle_mass
        self.wheelbase_length = wheelbase_length
        self.cg_height = cg_height
        self.tire_radius = tire_radius
        self.gear_ratio_hs = gear_ratio_hs
        self.inertia_wheel_front = inertia_wheel_front
        self.inertia_wheel_rear = inertia_wheel_rear
        self.regen_efficiency = regen_efficiency
        
        # Lookup table for maximum regenerative torque (1-D T(u))
        # Based on motor angular velocity (rad/s) -> Max regen torque (Nm)
        self.regen_torque_table_omega = np.array([0, 4, 22, 66, 92, 97, 98, 98, 98, 98, 98])
        self.regen_torque_table_values = np.array([0, 0.89, 1.78, 2.67, 3.56, 4.44, 5.33, 6, 6.5,7.0,8])
        self.z_parameters = np.arange(0.0, 1.1 + 0.001, 0.001)
        self.maximum_braking_torque_coeffience = 7.276877496000000e+03
        
        # r_f parameters from Excel data (1101 values matching z_parameters)
        self.r_f_parameters = np.array([0, 0.490220339, 0.490440678, 0.490661017, 0.490881356, 0.491101695, 0.491322034, 0.491542373, 0.491762712, 0.491983051, 0.49220339, 0.492423729, 0.492644068, 0.492864407, 0.493084746, 0.493305085, 0.493525424, 0.493745763, 0.493966102, 0.494186441, 0.49440678, 0.494627119, 0.494847458, 0.495067797, 0.495288136, 0.495508475, 0.495728814, 0.495949153, 0.496169492, 0.496389831, 0.496610169, 0.496830508, 0.497050847, 0.497271186, 0.497491525, 0.497711864, 0.497932203, 0.498152542, 0.498372881, 0.49859322, 0.498813559, 0.499033898, 0.499254237, 0.499474576, 0.499694915, 0.499915254, 0.500135593, 0.500355932, 0.500576271, 0.50079661, 0.501016949, 0.501237288, 0.501457627, 0.501677966, 0.501898305, 0.502118644, 0.502338983, 0.502559322, 0.502779661, 0.503, 0.503220339, 0.503440678, 0.503661017, 0.503881356, 0.504101695, 0.504322034, 0.504542373, 0.504762712, 0.504983051, 0.50520339, 0.505423729, 0.505644068, 0.505864407, 0.506084746, 0.506305085, 0.506525424, 0.506745763, 0.506966102, 0.507186441, 0.50740678, 0.507627119, 0.507847458, 0.508067797, 0.508288136, 0.508508475, 0.508728814, 0.508949153, 0.509169492, 0.509389831, 0.509610169, 0.509830508, 0.510050847, 0.510271186, 0.510491525, 0.510711864, 0.510932203, 0.511152542, 0.511372881, 0.51159322, 0.511813559, 0.512033898, 0.512254237, 0.512474576, 0.512694915, 0.512915254, 0.513135593, 0.513355932, 0.513576271, 0.51379661, 0.514016949, 0.514237288, 0.514457627, 0.514677966, 0.514898305, 0.515118644, 0.515338983, 0.515559322, 0.515779661, 0.516, 0.516220339, 0.516440678, 0.516661017, 0.516881356, 0.517101695, 0.517322034, 0.517542373, 0.517762712, 0.517983051, 0.51820339, 0.518423729, 0.518644068, 0.518864407, 0.519084746, 0.519305085, 0.519525424, 0.519745763, 0.519966102, 0.520186441, 0.52040678, 0.520627119, 0.520847458, 0.521067797, 0.521288136, 0.521508475, 0.521728814, 0.521949153, 0.522169492, 0.522389831, 0.522610169, 0.522830508, 0.523050847, 0.523271186, 0.523491525, 0.523711864, 0.523932203, 0.524152542, 0.524372881, 0.52459322, 0.524813559, 0.525033898, 0.525254237, 0.525474576, 0.525694915, 0.525915254, 0.526135593, 0.526355932, 0.526576271, 0.52679661, 0.527016949, 0.527237288, 0.527457627, 0.527677966, 0.527898305, 0.528118644, 0.528338983, 0.528559322, 0.528779661, 0.529, 0.529220339, 0.529440678, 0.529661017, 0.529881356, 0.530101695, 0.530322034, 0.530542373, 0.530762712, 0.530983051, 0.53120339, 0.531423729, 0.531644068, 0.531864407, 0.532084746, 0.532305085, 0.532525424, 0.532745763, 0.532966102, 0.533186441, 0.53340678, 0.533627119, 0.533847458, 0.534067797, 0.534288136, 0.534508475, 0.534728814, 0.534949153, 0.535169492, 0.535389831, 0.535610169, 0.535830508, 0.536050847, 0.536271186, 0.536491525, 0.536711864, 0.536932203, 0.537152542, 0.537372881, 0.53759322, 0.537813559, 0.538033898, 0.538254237, 0.538474576, 0.538694915, 0.538915254, 0.539135593, 0.539355932, 0.539576271, 0.53979661, 0.540016949, 0.540237288, 0.540457627, 0.540677966, 0.540898305, 0.541118644, 0.541338983, 0.541559322, 0.541779661, 0.542, 0.542220339, 0.542440678, 0.542661017, 0.542881356, 0.543101695, 0.543322034, 0.543542373, 0.543762712, 0.543983051, 0.54420339, 0.544423729, 0.544644068, 0.544864407, 0.545084746, 0.545305085, 0.545525424, 0.545745763, 0.545966102, 0.546186441, 0.54640678, 0.546627119, 0.546847458, 0.547067797, 0.547288136, 0.547508475, 0.547728814, 0.547949153, 0.548169492, 0.548389831, 0.548610169, 0.548830508, 0.549050847, 0.549271186, 0.549491525, 0.549711864, 0.549932203, 0.550152542, 0.550372881, 0.55059322, 0.550813559, 0.551033898, 0.551254237, 0.551474576, 0.551694915, 0.551915254, 0.552135593, 0.552355932, 0.552576271, 0.55279661, 0.553016949, 0.553237288, 0.553457627, 0.553677966, 0.553898305, 0.554118644, 0.554338983, 0.554559322, 0.554779661, 0.555, 0.555220339, 0.555440678, 0.555661017, 0.555881356, 0.556101695, 0.556322034, 0.556542373, 0.556762712, 0.556983051, 0.55720339, 0.557423729, 0.557644068, 0.557864407, 0.558084746, 0.558305085, 0.558525424, 0.558745763, 0.558966102, 0.559186441, 0.55940678, 0.559627119, 0.559847458, 0.560067797, 0.560288136, 0.560508475, 0.560728814, 0.560949153, 0.561169492, 0.561389831, 0.561610169, 0.561830508, 0.562050847, 0.562271186, 0.562491525, 0.562711864, 0.562932203, 0.563152542, 0.563372881, 0.56359322, 0.563813559, 0.564033898, 0.564254237, 0.564474576, 0.564694915, 0.564915254, 0.565135593, 0.565355932, 0.565576271, 0.56579661, 0.566016949, 0.566237288, 0.566457627, 0.566677966, 0.566898305, 0.567118644, 0.567338983, 0.567559322, 0.567779661, 0.568, 0.568220339, 0.568440678, 0.568661017, 0.568881356, 0.569101695, 0.569322034, 0.569542373, 0.569762712, 0.569983051, 0.57020339, 0.570423729, 0.570644068, 0.570864407, 0.571084746, 0.571305085, 0.571525424, 0.571745763, 0.571966102, 0.572186441, 0.57240678, 0.572627119, 0.572847458, 0.573067797, 0.573288136, 0.573508475, 0.573728814, 0.573949153, 0.574169492, 0.574389831, 0.574610169, 0.574830508, 0.575050847, 0.575271186, 0.575491525, 0.575711864, 0.575932203, 0.576152542, 0.576372881, 0.57659322, 0.576813559, 0.577033898, 0.577254237, 0.577474576, 0.577694915, 0.577915254, 0.578135593, 0.578355932, 0.578576271, 0.57879661, 0.579016949, 0.579237288, 0.579457627, 0.579677966, 0.579898305, 0.580118644, 0.580338983, 0.580559322, 0.580779661, 0.581, 0.581220339, 0.581440678, 0.581661017, 0.581881356, 0.582101695, 0.582322034, 0.582542373, 0.582762712, 0.582983051, 0.58320339, 0.583423729, 0.583644068, 0.583864407, 0.584084746, 0.584305085, 0.584525424, 0.584745763, 0.584966102, 0.585186441, 0.58540678, 0.585627119, 0.585847458, 0.586067797, 0.586288136, 0.586508475, 0.586728814, 0.586949153, 0.587169492, 0.587389831, 0.587610169, 0.587830508, 0.588050847, 0.588271186, 0.588491525, 0.588711864, 0.588932203, 0.589152542, 0.589372881, 0.58959322, 0.589813559, 0.590033898, 0.590254237, 0.590474576, 0.590694915, 0.590915254, 0.591135593, 0.591355932, 0.591576271, 0.59179661, 0.592016949, 0.592237288, 0.592457627, 0.592677966, 0.592898305, 0.593118644, 0.593338983, 0.593559322, 0.593779661, 0.594, 0.594220339, 0.594440678, 0.594661017, 0.594881356, 0.595101695, 0.595322034, 0.595542373, 0.595762712, 0.595983051, 0.59620339, 0.596423729, 0.596644068, 0.596864407, 0.597084746, 0.597305085, 0.597525424, 0.597745763, 0.597966102, 0.598186441, 0.59840678, 0.598627119, 0.598847458, 0.599067797, 0.599288136, 0.599508475, 0.599728814, 0.599949153, 0.600169492, 0.600389831, 0.600610169, 0.600830508, 0.601050847, 0.601271186, 0.601491525, 0.601711864, 0.601932203, 0.602152542, 0.602372881, 0.60259322, 0.602813559, 0.603033898, 0.603254237, 0.603474576, 0.603694915, 0.603915254, 0.604135593, 0.604355932, 0.604576271, 0.60479661, 0.605016949, 0.605237288, 0.605457627, 0.605677966, 0.605898305, 0.606118644, 0.606338983, 0.606559322, 0.606779661, 0.607, 0.607220339, 0.607440678, 0.607661017, 0.607881356, 0.608101695, 0.608322034, 0.608542373, 0.608762712, 0.608983051, 0.60920339, 0.609423729, 0.609644068, 0.609864407, 0.610084746, 0.610305085, 0.610525424, 0.610745763, 0.610966102, 0.611186441, 0.61140678, 0.611627119, 0.611847458, 0.612067797, 0.612288136, 0.612508475, 0.612728814, 0.612949153, 0.613169492, 0.613389831, 0.613610169, 0.613830508, 0.614050847, 0.614271186, 0.614491525, 0.614711864, 0.614932203, 0.615152542, 0.615372881, 0.61559322, 0.615813559, 0.616033898, 0.616254237, 0.616474576, 0.616694915, 0.616915254, 0.617135593, 0.617355932, 0.617576271, 0.61779661, 0.618016949, 0.618237288, 0.618457627, 0.618677966, 0.618898305, 0.619118644, 0.619338983, 0.619559322, 0.619779661, 0.62, 0.620220339, 0.620440678, 0.620661017, 0.620881356, 0.621101695, 0.621322034, 0.621542373, 0.621762712, 0.621983051, 0.62220339, 0.622423729, 0.622644068, 0.622864407, 0.623084746, 0.623305085, 0.623525424, 0.623745763, 0.623966102, 0.624186441, 0.62440678, 0.624627119, 0.624847458, 0.625067797, 0.625288136, 0.625508475, 0.625728814, 0.625949153, 0.626169492, 0.626389831, 0.626610169, 0.626830508, 0.627050847, 0.627271186, 0.627491525, 0.627711864, 0.627932203, 0.628152542, 0.628372881, 0.62859322, 0.628813559, 0.629033898, 0.629254237, 0.629474576, 0.629694915, 0.629915254, 0.630135593, 0.630355932, 0.630576271, 0.63079661, 0.631016949, 0.631237288, 0.631457627, 0.631677966, 0.631898305, 0.632118644, 0.632338983, 0.632559322, 0.632779661, 0.633, 0.633220339, 0.633440678, 0.633661017, 0.633881356, 0.634101695, 0.634322034, 0.634542373, 0.634762712, 0.634983051, 0.63520339, 0.635423729, 0.635644068, 0.635864407, 0.636084746, 0.636305085, 0.636525424, 0.636745763, 0.636966102, 0.637186441, 0.63740678, 0.637627119, 0.637847458, 0.638067797, 0.638288136, 0.638508475, 0.638728814, 0.638949153, 0.639169492, 0.639389831, 0.639610169, 0.639830508, 0.640050847, 0.640271186, 0.640491525, 0.640711864, 0.640932203, 0.641152542, 0.641372881, 0.64159322, 0.641813559, 0.642033898, 0.642254237, 0.642474576, 0.642694915, 0.642915254, 0.643135593, 0.643355932, 0.643576271, 0.64379661, 0.644016949, 0.644237288, 0.644457627, 0.644677966, 0.644898305, 0.645118644, 0.645338983, 0.645559322, 0.645779661, 0.646, 0.646220339, 0.646440678, 0.646661017, 0.646881356, 0.647101695, 0.647322034, 0.647542373, 0.647762712, 0.647983051, 0.64820339, 0.648423729, 0.648644068, 0.648864407, 0.649084746, 0.649305085, 0.649525424, 0.649745763, 0.649966102, 0.650186441, 0.65040678, 0.650627119, 0.650847458, 0.651067797, 0.651288136, 0.651508475, 0.651728814, 0.651949153, 0.652169492, 0.652389831, 0.652610169, 0.652830508, 0.653050847, 0.653271186, 0.653491525, 0.653711864, 0.653932203, 0.654152542, 0.654372881, 0.65459322, 0.654813559, 0.655033898, 0.655254237, 0.655474576, 0.655694915, 0.655915254, 0.656135593, 0.656355932, 0.656576271, 0.65679661, 0.657016949, 0.657237288, 0.657457627, 0.657677966, 0.657898305, 0.658118644, 0.658338983, 0.658559322, 0.658779661, 0.659, 0.659220339, 0.659440678, 0.659661017, 0.659881356, 0.660101695, 0.660322034, 0.660542373, 0.660762712, 0.660983051, 0.66120339, 0.661423729, 0.661644068, 0.661864407, 0.662084746, 0.662305085, 0.662525424, 0.662745763, 0.662966102, 0.663186441, 0.66340678, 0.663627119, 0.663847458, 0.664067797, 0.664288136, 0.664508475, 0.664728814, 0.664949153, 0.665169492, 0.665389831, 0.665610169, 0.665830508, 0.666050847, 0.666271186, 0.666491525, 0.666711864, 0.666932203, 0.667152542, 0.667372881, 0.66759322, 0.667813559, 0.668033898, 0.668254237, 0.668474576, 0.668694915, 0.668915254, 0.669135593, 0.669355932, 0.669576271, 0.66979661, 0.670016949, 0.670237288, 0.670457627, 0.670677966, 0.670898305, 0.671118644, 0.671338983, 0.671559322, 0.671779661, 0.672, 0.672220339, 0.672440678, 0.672661017, 0.672881356, 0.673101695, 0.673322034, 0.673542373, 0.673762712, 0.673983051, 0.67420339, 0.674423729, 0.674644068, 0.674864407, 0.675084746, 0.675305085, 0.675525424, 0.675745763, 0.675966102, 0.676186441, 0.67640678, 0.676627119, 0.676847458, 0.677067797, 0.677288136, 0.677508475, 0.677728814, 0.677949153, 0.678169492, 0.678389831, 0.678610169, 0.678830508, 0.679050847, 0.679271186, 0.679491525, 0.679711864, 0.679932203, 0.680152542, 0.680372881, 0.68059322, 0.680813559, 0.681033898, 0.681254237, 0.681474576, 0.681694915, 0.681915254, 0.682135593, 0.682355932, 0.682576271, 0.68279661, 0.683016949, 0.683237288, 0.683457627, 0.683677966, 0.683898305, 0.684118644, 0.684338983, 0.684559322, 0.684779661, 0.685, 0.685220339, 0.685440678, 0.685661017, 0.685881356, 0.686101695, 0.686322034, 0.686542373, 0.686762712, 0.686983051, 0.68720339, 0.687423729, 0.687644068, 0.687864407, 0.688084746, 0.688305085, 0.688525424, 0.688745763, 0.688966102, 0.689186441, 0.68940678, 0.689627119, 0.689847458, 0.690067797, 0.690288136, 0.690508475, 0.690728814, 0.690949153, 0.691169492, 0.691389831, 0.691610169, 0.691830508, 0.692050847, 0.692271186, 0.692491525, 0.692711864, 0.692932203, 0.693152542, 0.693372881, 0.69359322, 0.693813559, 0.694033898, 0.694254237, 0.694474576, 0.694694915, 0.694915254, 0.695135593, 0.695355932, 0.695576271, 0.69579661, 0.696016949, 0.696237288, 0.696457627, 0.696677966, 0.696898305, 0.697118644, 0.697338983, 0.697559322, 0.697779661, 0.698, 0.698220339, 0.698440678, 0.698661017, 0.698881356, 0.699101695, 0.699322034, 0.699542373, 0.699762712, 0.699983051, 0.70020339, 0.700423729, 0.700644068, 0.700864407, 0.701084746, 0.701305085, 0.701525424, 0.701745763, 0.701966102, 0.702186441, 0.70240678, 0.702627119, 0.702847458, 0.703067797, 0.703288136, 0.703508475, 0.703728814, 0.703949153, 0.704169492, 0.704389831, 0.704610169, 0.704830508, 0.705050847, 0.705271186, 0.705491525, 0.705711864, 0.705932203, 0.706152542, 0.706372881, 0.70659322, 0.706813559, 0.707033898, 0.707254237, 0.707474576, 0.707694915, 0.707915254, 0.708135593, 0.708355932, 0.708576271, 0.70879661, 0.709016949, 0.709237288, 0.709457627, 0.709677966, 0.709898305, 0.710118644, 0.710338983, 0.710559322, 0.710779661, 0.711, 0.711220339, 0.711440678, 0.711661017, 0.711881356, 0.712101695, 0.712322034, 0.712542373, 0.712762712, 0.712983051, 0.71320339, 0.713423729, 0.713644068, 0.713864407, 0.714084746, 0.714305085, 0.714525424, 0.714745763, 0.714966102, 0.715186441, 0.71540678, 0.715627119, 0.715847458, 0.716067797, 0.716288136, 0.716508475, 0.716728814, 0.716949153, 0.717169492, 0.717389831, 0.717610169, 0.717830508, 0.718050847, 0.718271186, 0.718491525, 0.718711864, 0.718932203, 0.719152542, 0.719372881, 0.71959322, 0.719813559, 0.720033898, 0.720254237, 0.720474576, 0.720694915, 0.720915254, 0.721135593, 0.721355932, 0.721576271, 0.72179661, 0.722016949, 0.722237288, 0.722457627, 0.722677966, 0.722898305, 0.723118644, 0.723338983, 0.723559322, 0.723779661, 0.724, 0.724220339, 0.724440678, 0.724661017, 0.724881356, 0.725101695, 0.725322034, 0.725542373, 0.725762712, 0.725983051, 0.72620339, 0.726423729, 0.726644068, 0.726864407, 0.727084746, 0.727305085, 0.727525424, 0.727745763, 0.727966102, 0.728186441, 0.72840678, 0.728627119, 0.728847458, 0.729067797, 0.729288136, 0.729508475, 0.729728814, 0.729949153, 0.730169492, 0.730389831, 0.730610169, 0.730830508, 0.731050847, 0.731271186, 0.731491525, 0.731711864, 0.731932203, 0.732152542, 0.732372881])
        
        # r_r parameters from Excel data
        self.r_r_parameters = np.array([0, 0.509779661, 0.509559322, 0.509338983, 0.509118644, 0.508898305, 0.508677966, 0.508457627, 0.508237288, 0.508016949, 0.50779661, 0.507576271, 0.507355932, 0.507135593, 0.506915254, 0.506694915, 0.506474576, 0.506254237, 0.506033898, 0.505813559, 0.50559322, 0.505372881, 0.505152542, 0.504932203, 0.504711864, 0.504491525, 0.504271186, 0.504050847, 0.503830508, 0.503610169, 0.503389831, 0.503169492, 0.502949153, 0.502728814, 0.502508475, 0.502288136, 0.502067797, 0.501847458, 0.501627119, 0.50140678, 0.501186441, 0.500966102, 0.500745763, 0.500525424, 0.500305085, 0.500084746, 0.499864407, 0.499644068, 0.499423729, 0.49920339, 0.498983051, 0.498762712, 0.498542373, 0.498322034, 0.498101695, 0.497881356, 0.497661017, 0.497440678, 0.497220339, 0.497, 0.496779661, 0.496559322, 0.496338983, 0.496118644, 0.495898305, 0.495677966, 0.495457627, 0.495237288, 0.495016949, 0.49479661, 0.494576271, 0.494355932, 0.494135593, 0.493915254, 0.493694915, 0.493474576, 0.493254237, 0.493033898, 0.492813559, 0.49259322, 0.492372881, 0.492152542, 0.491932203, 0.491711864, 0.491491525, 0.491271186, 0.491050847, 0.490830508, 0.490610169, 0.490389831, 0.490169492, 0.489949153, 0.489728814, 0.489508475, 0.489288136, 0.489067797, 0.488847458, 0.488627119, 0.48840678, 0.488186441, 0.487966102, 0.487745763, 0.487525424, 0.487305085, 0.487084746, 0.486864407, 0.486644068, 0.486423729, 0.48620339, 0.485983051, 0.485762712, 0.485542373, 0.485322034, 0.485101695, 0.484881356, 0.484661017, 0.484440678, 0.484220339, 0.484, 0.483779661, 0.483559322, 0.483338983, 0.483118644, 0.482898305, 0.482677966, 0.482457627, 0.482237288, 0.482016949, 0.48179661, 0.481576271, 0.481355932, 0.481135593, 0.480915254, 0.480694915, 0.480474576, 0.480254237, 0.480033898, 0.479813559, 0.47959322, 0.479372881, 0.479152542, 0.478932203, 0.478711864, 0.478491525, 0.478271186, 0.478050847, 0.477830508, 0.477610169, 0.477389831, 0.477169492, 0.476949153, 0.476728814, 0.476508475, 0.476288136, 0.476067797, 0.475847458, 0.475627119, 0.47540678, 0.475186441, 0.474966102, 0.474745763, 0.474525424, 0.474305085, 0.474084746, 0.473864407, 0.473644068, 0.473423729, 0.47320339, 0.472983051, 0.472762712, 0.472542373, 0.472322034, 0.472101695, 0.471881356, 0.471661017, 0.471440678, 0.471220339, 0.471, 0.470779661, 0.470559322, 0.470338983, 0.470118644, 0.469898305, 0.469677966, 0.469457627, 0.469237288, 0.469016949, 0.46879661, 0.468576271, 0.468355932, 0.468135593, 0.467915254, 0.467694915, 0.467474576, 0.467254237, 0.467033898, 0.466813559, 0.46659322, 0.466372881, 0.466152542, 0.465932203, 0.465711864, 0.465491525, 0.465271186, 0.465050847, 0.464830508, 0.464610169, 0.464389831, 0.464169492, 0.463949153, 0.463728814, 0.463508475, 0.463288136, 0.463067797, 0.462847458, 0.462627119, 0.46240678, 0.462186441, 0.461966102, 0.461745763, 0.461525424, 0.461305085, 0.461084746, 0.460864407, 0.460644068, 0.460423729, 0.46020339, 0.459983051, 0.459762712, 0.459542373, 0.459322034, 0.459101695, 0.458881356, 0.458661017, 0.458440678, 0.458220339, 0.458, 0.457779661, 0.457559322, 0.457338983, 0.457118644, 0.456898305, 0.456677966, 0.456457627, 0.456237288, 0.456016949, 0.45579661, 0.455576271, 0.455355932, 0.455135593, 0.454915254, 0.454694915, 0.454474576, 0.454254237, 0.454033898, 0.453813559, 0.45359322, 0.453372881, 0.453152542, 0.452932203, 0.452711864, 0.452491525, 0.452271186, 0.452050847, 0.451830508, 0.451610169, 0.451389831, 0.451169492, 0.450949153, 0.450728814, 0.450508475, 0.450288136, 0.450067797, 0.449847458, 0.449627119, 0.44940678, 0.449186441, 0.448966102, 0.448745763, 0.448525424, 0.448305085, 0.448084746, 0.447864407, 0.447644068, 0.447423729, 0.44720339, 0.446983051, 0.446762712, 0.446542373, 0.446322034, 0.446101695, 0.445881356, 0.445661017, 0.445440678, 0.445220339, 0.445, 0.444779661, 0.444559322, 0.444338983, 0.444118644, 0.443898305, 0.443677966, 0.443457627, 0.443237288, 0.443016949, 0.44279661, 0.442576271, 0.442355932, 0.442135593, 0.441915254, 0.441694915, 0.441474576, 0.441254237, 0.441033898, 0.440813559, 0.44059322, 0.440372881, 0.440152542, 0.439932203, 0.439711864, 0.439491525, 0.439271186, 0.439050847, 0.438830508, 0.438610169, 0.438389831, 0.438169492, 0.437949153, 0.437728814, 0.437508475, 0.437288136, 0.437067797, 0.436847458, 0.436627119, 0.43640678, 0.436186441, 0.435966102, 0.435745763, 0.435525424, 0.435305085, 0.435084746, 0.434864407, 0.434644068, 0.434423729, 0.43420339, 0.433983051, 0.433762712, 0.433542373, 0.433322034, 0.433101695, 0.432881356, 0.432661017, 0.432440678, 0.432220339, 0.432, 0.431779661, 0.431559322, 0.431338983, 0.431118644, 0.430898305, 0.430677966, 0.430457627, 0.430237288, 0.430016949, 0.42979661, 0.429576271, 0.429355932, 0.429135593, 0.428915254, 0.428694915, 0.428474576, 0.428254237, 0.428033898, 0.427813559, 0.42759322, 0.427372881, 0.427152542, 0.426932203, 0.426711864, 0.426491525, 0.426271186, 0.426050847, 0.425830508, 0.425610169, 0.425389831, 0.425169492, 0.424949153, 0.424728814, 0.424508475, 0.424288136, 0.424067797, 0.423847458, 0.423627119, 0.42340678, 0.423186441, 0.422966102, 0.422745763, 0.422525424, 0.422305085, 0.422084746, 0.421864407, 0.421644068, 0.421423729, 0.42120339, 0.420983051, 0.420762712, 0.420542373, 0.420322034, 0.420101695, 0.419881356, 0.419661017, 0.419440678, 0.419220339, 0.419, 0.418779661, 0.418559322, 0.418338983, 0.418118644, 0.417898305, 0.417677966, 0.417457627, 0.417237288, 0.417016949, 0.41679661, 0.416576271, 0.416355932, 0.416135593, 0.415915254, 0.415694915, 0.415474576, 0.415254237, 0.415033898, 0.414813559, 0.41459322, 0.414372881, 0.414152542, 0.413932203, 0.413711864, 0.413491525, 0.413271186, 0.413050847, 0.412830508, 0.412610169, 0.412389831, 0.412169492, 0.411949153, 0.411728814, 0.411508475, 0.411288136, 0.411067797, 0.410847458, 0.410627119, 0.41040678, 0.410186441, 0.409966102, 0.409745763, 0.409525424, 0.409305085, 0.409084746, 0.408864407, 0.408644068, 0.408423729, 0.40820339, 0.407983051, 0.407762712, 0.407542373, 0.407322034, 0.407101695, 0.406881356, 0.406661017, 0.406440678, 0.406220339, 0.406, 0.405779661, 0.405559322, 0.405338983, 0.405118644, 0.404898305, 0.404677966, 0.404457627, 0.404237288, 0.404016949, 0.40379661, 0.403576271, 0.403355932, 0.403135593, 0.402915254, 0.402694915, 0.402474576, 0.402254237, 0.402033898, 0.401813559, 0.40159322, 0.401372881, 0.401152542, 0.400932203, 0.400711864, 0.400491525, 0.400271186, 0.400050847, 0.399830508, 0.399610169, 0.399389831, 0.399169492, 0.398949153, 0.398728814, 0.398508475, 0.398288136, 0.398067797, 0.397847458, 0.397627119, 0.39740678, 0.397186441, 0.396966102, 0.396745763, 0.396525424, 0.396305085, 0.396084746, 0.395864407, 0.395644068, 0.395423729, 0.39520339, 0.394983051, 0.394762712, 0.394542373, 0.394322034, 0.394101695, 0.393881356, 0.393661017, 0.393440678, 0.393220339, 0.393, 0.392779661, 0.392559322, 0.392338983, 0.392118644, 0.391898305, 0.391677966, 0.391457627, 0.391237288, 0.391016949, 0.39079661, 0.390576271, 0.390355932, 0.390135593, 0.389915254, 0.389694915, 0.389474576, 0.389254237, 0.389033898, 0.388813559, 0.38859322, 0.388372881, 0.388152542, 0.387932203, 0.387711864, 0.387491525, 0.387271186, 0.387050847, 0.386830508, 0.386610169, 0.386389831, 0.386169492, 0.385949153, 0.385728814, 0.385508475, 0.385288136, 0.385067797, 0.384847458, 0.384627119, 0.38440678, 0.384186441, 0.383966102, 0.383745763, 0.383525424, 0.383305085, 0.383084746, 0.382864407, 0.382644068, 0.382423729, 0.38220339, 0.381983051, 0.381762712, 0.381542373, 0.381322034, 0.381101695, 0.380881356, 0.380661017, 0.380440678, 0.380220339, 0.38, 0.379779661, 0.379559322, 0.379338983, 0.379118644, 0.378898305, 0.378677966, 0.378457627, 0.378237288, 0.378016949, 0.37779661, 0.377576271, 0.377355932, 0.377135593, 0.376915254, 0.376694915, 0.376474576, 0.376254237, 0.376033898, 0.375813559, 0.37559322, 0.375372881, 0.375152542, 0.374932203, 0.374711864, 0.374491525, 0.374271186, 0.374050847, 0.373830508, 0.373610169, 0.373389831, 0.373169492, 0.372949153, 0.372728814, 0.372508475, 0.372288136, 0.372067797, 0.371847458, 0.371627119, 0.37140678, 0.371186441, 0.370966102, 0.370745763, 0.370525424, 0.370305085, 0.370084746, 0.369864407, 0.369644068, 0.369423729, 0.36920339, 0.368983051, 0.368762712, 0.368542373, 0.368322034, 0.368101695, 0.367881356, 0.367661017, 0.367440678, 0.367220339, 0.367, 0.366779661, 0.366559322, 0.366338983, 0.366118644, 0.365898305, 0.365677966, 0.365457627, 0.365237288, 0.365016949, 0.36479661, 0.364576271, 0.364355932, 0.364135593, 0.363915254, 0.363694915, 0.363474576, 0.363254237, 0.363033898, 0.362813559, 0.36259322, 0.362372881, 0.362152542, 0.361932203, 0.361711864, 0.361491525, 0.361271186, 0.361050847, 0.360830508, 0.360610169, 0.360389831, 0.360169492, 0.359949153, 0.359728814, 0.359508475, 0.359288136, 0.359067797, 0.358847458, 0.358627119, 0.35840678, 0.358186441, 0.357966102, 0.357745763, 0.357525424, 0.357305085, 0.357084746, 0.356864407, 0.356644068, 0.356423729, 0.35620339, 0.355983051, 0.355762712, 0.355542373, 0.355322034, 0.355101695, 0.354881356, 0.354661017, 0.354440678, 0.354220339, 0.354, 0.353779661, 0.353559322, 0.353338983, 0.353118644, 0.352898305, 0.352677966, 0.352457627, 0.352237288, 0.352016949, 0.35179661, 0.351576271, 0.351355932, 0.351135593, 0.350915254, 0.350694915, 0.350474576, 0.350254237, 0.350033898, 0.349813559, 0.34959322, 0.349372881, 0.349152542, 0.348932203, 0.348711864, 0.348491525, 0.348271186, 0.348050847, 0.347830508, 0.347610169, 0.347389831, 0.347169492, 0.346949153, 0.346728814, 0.346508475, 0.346288136, 0.346067797, 0.345847458, 0.345627119, 0.34540678, 0.345186441, 0.344966102, 0.344745763, 0.344525424, 0.344305085, 0.344084746, 0.343864407, 0.343644068, 0.343423729, 0.34320339, 0.342983051, 0.342762712, 0.342542373, 0.342322034, 0.342101695, 0.341881356, 0.341661017, 0.341440678, 0.341220339, 0.341, 0.340779661, 0.340559322, 0.340338983, 0.340118644, 0.339898305, 0.339677966, 0.339457627, 0.339237288, 0.339016949, 0.33879661, 0.338576271, 0.338355932, 0.338135593, 0.337915254, 0.337694915, 0.337474576, 0.337254237, 0.337033898, 0.336813559, 0.33659322, 0.336372881, 0.336152542, 0.335932203, 0.335711864, 0.335491525, 0.335271186, 0.335050847, 0.334830508, 0.334610169, 0.334389831, 0.334169492, 0.333949153, 0.333728814, 0.333508475, 0.333288136, 0.333067797, 0.332847458, 0.332627119, 0.33240678, 0.332186441, 0.331966102, 0.331745763, 0.331525424, 0.331305085, 0.331084746, 0.330864407, 0.330644068, 0.330423729, 0.33020339, 0.329983051, 0.329762712, 0.329542373, 0.329322034, 0.329101695, 0.328881356, 0.328661017, 0.328440678, 0.328220339, 0.328, 0.327779661, 0.327559322, 0.327338983, 0.327118644, 0.326898305, 0.326677966, 0.326457627, 0.326237288, 0.326016949, 0.32579661, 0.325576271, 0.325355932, 0.325135593, 0.324915254, 0.324694915, 0.324474576, 0.324254237, 0.324033898, 0.323813559, 0.32359322, 0.323372881, 0.323152542, 0.322932203, 0.322711864, 0.322491525, 0.322271186, 0.322050847, 0.321830508, 0.321610169, 0.321389831, 0.321169492, 0.320949153, 0.320728814, 0.320508475, 0.320288136, 0.320067797, 0.319847458, 0.319627119, 0.31940678, 0.319186441, 0.318966102, 0.318745763, 0.318525424, 0.318305085, 0.318084746, 0.317864407, 0.317644068, 0.317423729, 0.31720339, 0.316983051, 0.316762712, 0.316542373, 0.316322034, 0.316101695, 0.315881356, 0.315661017, 0.315440678, 0.315220339, 0.315, 0.314779661, 0.314559322, 0.314338983, 0.314118644, 0.313898305, 0.313677966, 0.313457627, 0.313237288, 0.313016949, 0.31279661, 0.312576271, 0.312355932, 0.312135593, 0.311915254, 0.311694915, 0.311474576, 0.311254237, 0.311033898, 0.310813559, 0.31059322, 0.310372881, 0.310152542, 0.309932203, 0.309711864, 0.309491525, 0.309271186, 0.309050847, 0.308830508, 0.308610169, 0.308389831, 0.308169492, 0.307949153, 0.307728814, 0.307508475, 0.307288136, 0.307067797, 0.306847458, 0.306627119, 0.30640678, 0.306186441, 0.305966102, 0.305745763, 0.305525424, 0.305305085, 0.305084746, 0.304864407, 0.304644068, 0.304423729, 0.30420339, 0.303983051, 0.303762712, 0.303542373, 0.303322034, 0.303101695, 0.302881356, 0.302661017, 0.302440678, 0.302220339, 0.302, 0.301779661, 0.301559322, 0.301338983, 0.301118644, 0.300898305, 0.300677966, 0.300457627, 0.300237288, 0.300016949, 0.29979661, 0.299576271, 0.299355932, 0.299135593, 0.298915254, 0.298694915, 0.298474576, 0.298254237, 0.298033898, 0.297813559, 0.29759322, 0.297372881, 0.297152542, 0.296932203, 0.296711864, 0.296491525, 0.296271186, 0.296050847, 0.295830508, 0.295610169, 0.295389831, 0.295169492, 0.294949153, 0.294728814, 0.294508475, 0.294288136, 0.294067797, 0.293847458, 0.293627119, 0.29340678, 0.293186441, 0.292966102, 0.292745763, 0.292525424, 0.292305085, 0.292084746, 0.291864407, 0.291644068, 0.291423729, 0.29120339, 0.290983051, 0.290762712, 0.290542373, 0.290322034, 0.290101695, 0.289881356, 0.289661017, 0.289440678, 0.289220339, 0.289, 0.288779661, 0.288559322, 0.288338983, 0.288118644, 0.287898305, 0.287677966, 0.287457627, 0.287237288, 0.287016949, 0.28679661, 0.286576271, 0.286355932, 0.286135593, 0.285915254, 0.285694915, 0.285474576, 0.285254237, 0.285033898, 0.284813559, 0.28459322, 0.284372881, 0.284152542, 0.283932203, 0.283711864, 0.283491525, 0.283271186, 0.283050847, 0.282830508, 0.282610169, 0.282389831, 0.282169492, 0.281949153, 0.281728814, 0.281508475, 0.281288136, 0.281067797, 0.280847458, 0.280627119, 0.28040678, 0.280186441, 0.279966102, 0.279745763, 0.279525424, 0.279305085, 0.279084746, 0.278864407, 0.278644068, 0.278423729, 0.27820339, 0.277983051, 0.277762712, 0.277542373, 0.277322034, 0.277101695, 0.276881356, 0.276661017, 0.276440678, 0.276220339, 0.276, 0.275779661, 0.275559322, 0.275338983, 0.275118644, 0.274898305, 0.274677966, 0.274457627, 0.274237288, 0.274016949, 0.27379661, 0.273576271, 0.273355932, 0.273135593, 0.272915254, 0.272694915, 0.272474576, 0.272254237, 0.272033898, 0.271813559, 0.27159322, 0.271372881, 0.271152542, 0.270932203, 0.270711864, 0.270491525, 0.270271186, 0.270050847, 0.269830508, 0.269610169, 0.269389831, 0.269169492, 0.268949153, 0.268728814, 0.268508475, 0.268288136, 0.268067797, 0.267847458, 0.267627119])
        
        # Mode selection thresholds
        self.low_regen_threshold = 0.08  # Low regen mode threshold
        
    def calculate_max_regen_torque(self, motor_angular_velocity,velocity_ms):
        """
        Calculate maximum regenerative torque based on motor speed
        Using 1-D lookup table
        """
        # Interpolate from lookup table for velocity
        max_regen_torque_coeffience = np.interp(
            abs(velocity_ms),
            self.regen_torque_table_omega,
            self.regen_torque_table_values
        )
        if motor_angular_velocity <= 628.32:
            max_regen_torque = 250
        else:
            max_regen_torque = 250 * (658.32 / motor_angular_velocity)

        # Scale by gear ratio to get wheel torque
        max_regen_torque_wheel = max_regen_torque * max_regen_torque_coeffience  * self.gear_ratio_hs / 100.0
        
        return max_regen_torque_wheel
    
    def calculate_max_front_braking_torque(self, pedal_position, z_value):
        """
        Calculate maximum front braking torque based on z_value (emergency braking factor)
        Using 1-D lookup table with z_parameters as breakpoints
        
        Args:
            z_value: Emergency braking factor or normalized braking demand (0 to 1.1 range)
        """
        # Interpolate r_f coefficient from lookup table
        r_f_coefficient = np.interp(
            z_value,
            self.z_parameters,
            self.r_f_parameters
        )
        
        max_braking_torque = abs(pedal_position) * r_f_coefficient * self.maximum_braking_torque_coeffience
        return max_braking_torque
    def calculate_max_rear_braking_torque(self,pedal_position, z_value):
        """
        Calculate maximum rear braking torque based on z_value (emergency braking factor)
        Using 1-D lookup table with z_parameters as breakpoints
        
        Args:
            z_value: Emergency braking factor or normalized braking demand (0 to 1.1 range)
        """
        # Interpolate r_r coefficient from lookup table
        r_r_coefficient = np.interp(
            z_value,
            self.z_parameters,
            self.r_r_parameters
        )
        
        max_braking_torque = abs(pedal_position) * r_r_coefficient * self.maximum_braking_torque_coeffience
        return max_braking_torque
    
    def determine_braking_mode(self, pedal_position, front_max_regen):
        """
        Determine braking mode based on pedal position and front max regen torque
        Returns: tuple (braking_mode, mux_output)
        Based on Simulink diagram: 
        - MUX1 combines [mtst_toida, mtst_toida * C]
        - MUX2 interleaves with zeros: [mtst_toida, 0, mtst_toida * C, 0] or similar
        where C = 0.49/0.51
        """
        # C is the constant 0.49/0.51
        C = 0.49 / 0.51
        
        # Calculate comparison value
        comparison_value = C * front_max_regen
        
        # Determine mode
        if comparison_value < self.low_regen_threshold:
            # Low regen mode: P = 0 (regen braking system is active)
            mode = 'low_regen'
        else:
            # High regen mode
            mode = 'high_regen'
        
        # MUX 1: Create vector [mtst_toida, mtst_toida * C]
        mux1_output = [front_max_regen, front_max_regen * C]
        
        # MUX 2: Interleave with zeros
        # Output format: [front_regen, 0, rear_regen, 0]
        # where front_regen = mtst_toida, rear_regen = mtst_toida * C
        mux2_output = [mux1_output[0], 0, mux1_output[1], 0]
        
        return mode, mux2_output
    
    def switch_signal_output(self, pedal_position, velocity_ms, case1, case2):
        """
        Switch block logic from Simulink: P=0 & P < 0
        Select between Case1 (mux2_output) and Case2 (torque_mux)
        Based on pedal position and velocity conditions
        
        Args:
            pedal_position: Brake pedal position (negative for braking)
            velocity_ms: Vehicle velocity in m/s
            case1: mux2_output vector [mtst_toida, 0, mtst_toida*C, 0]
            case2: torque_mux vector [Tregen_f, Tregen_r, Tmech_f, Tmech_r]
        
        Returns:
            Signal_out: 4-element vector
        """
        # Initialize output
        Signal_out = [0.0, 0.0, 0.0, 0.0]
        
        # Check condition: Pedal in range (-0.05, 0.01) and velocity >= 0.5 m/s
        if pedal_position < 0.01 and pedal_position >= -0.05 and velocity_ms >= 0.5:
            Signal_out = case1
        else:
            Signal_out = case2
        
        return Signal_out
    
    def calculate_emergency_braking_factor(self, acceleration):
        """
        Calculate emergency braking factor z based on acceleration
        From Simulink: a -> fcn -> 1/g -> |u| -> z
        
        Args:
            acceleration: Vehicle acceleration in m/s² (negative for deceleration)
        
        Returns:
            z: Emergency braking factor
        """
        g = 9.81  # Gravity constant m/s²
        
        # Apply function to acceleration (likely checking if emergency condition)
        # For emergency braking, we check if deceleration exceeds threshold
        # Function block likely outputs acceleration value or applies some transformation
        
        # Calculate 1/g factor
        inv_g = 1.0 / g
        
        # Apply to acceleration and take absolute value
        z = abs(acceleration * inv_g)
        
        return z
    
    def create_emergency_mux(self, Tmech_f, Tmech_r):
        """
        Create emergency braking MUX vector: [0, Myct, 0, Mycs]
        where Myct = front mechanical torque, Mycs = rear mechanical torque
        
        Args:
            Tmech_f: Front mechanical braking torque
            Tmech_r: Rear mechanical braking torque
        
        Returns:
            emergency_mux: [0, Tmech_f, 0, Tmech_r]
        """
        emergency_mux = [0, Tmech_f, 0, Tmech_r]
        return emergency_mux
    
    def calculate_braking_torques(self,
                                   pedal_position,
                                   vehicle_velocity_ms,
                                   front_motor_angular_velocity,
                                   rear_motor_angular_velocity,
                                   front_vertical_load,
                                   rear_vertical_load,
                                   vehicle_acceleration):
        """
        Main function to calculate all braking torques
        
        Returns:
            dict: {
                'front_regen_torque': Front regenerative braking torque (Nm),
                'front_mechanical_torque': Front mechanical braking torque (Nm),
                'rear_regen_torque': Rear regenerative braking torque (Nm),
                'rear_mechanical_torque': Rear mechanical braking torque (Nm),
                'braking_mode': Current braking mode,
                'emergency_braking': Boolean flag
            }
        """
        
        outputs = {}
        
        # Check if braking is active (pedal position < 0)
        if pedal_position >= 0:
            # No braking
            outputs['front_regen_torque'] = 0.0
            outputs['front_mechanical_torque'] = 0.0
            outputs['rear_regen_torque'] = 0.0
            outputs['rear_mechanical_torque'] = 0.0
            outputs['braking_mode'] = 'none'
            outputs['emergency_braking'] = False
            return outputs
        
        # Calculate maximum regenerative torques
        front_max_regen = self.calculate_max_regen_torque(front_motor_angular_velocity,vehicle_velocity_ms)
        rear_max_regen = self.calculate_max_regen_torque(rear_motor_angular_velocity,vehicle_velocity_ms)
    
        # Calculate emergency braking factor z first
        z_value = self.calculate_emergency_braking_factor(vehicle_acceleration)
        outputs['emergency_factor_z'] = z_value
        
        # Calculate maximum braking torque required using z_value
        Front_max_braking_torque = self.calculate_max_front_braking_torque(pedal_position,z_value)
        Rear_max_braking_torque = self.calculate_max_rear_braking_torque(pedal_position,z_value)

        #Braking torque distribution statregy
        
        
        # Determine braking mode based on pedal position and front max regen
        braking_mode, mux_output = self.determine_braking_mode(pedal_position, front_max_regen)
        outputs['braking_mode'] = braking_mode
        outputs['mux_output'] = mux_output  # [front_regen_ref, 0, rear_regen_ref, 0]
        
        # Check for emergency braking (high deceleration)
        emergency_braking = (vehicle_acceleration < -5.0)  # Emergency if decel > 5 m/s²
        outputs['emergency_braking'] = emergency_braking
        
        # Braking Torque Distribution Strategy (from Simulink fcn block)
        # Initialize values
        Tregen_f = 0.0
        Tregen_r = 0.0
        Tmech_f = 0.0
        Tmech_r = 0.0
        
        Beta = 0.692  # Front/rear distribution ratio
        Tz = Front_max_braking_torque + Rear_max_braking_torque  # Total required torque
        
        # Case 1: Front regen can handle all front required torque
        if front_max_regen >= Front_max_braking_torque:
            Tregen_f = Front_max_braking_torque
            Tmech_f = 0.0
            Tregen_r = Rear_max_braking_torque
            Tmech_r = 0.0
        
        # Case 2: Front regen cannot handle all front required torque
        elif front_max_regen < Front_max_braking_torque:
            Tregen_f = front_max_regen
            Tmech_f = Front_max_braking_torque - Tregen_f
            Tmech_r = Tmech_f * ((1 - Beta) / Beta)
            
            # Case 2.1: Rear can handle regen + mechanical torque
            if (rear_max_regen + Tmech_r) >= Rear_max_braking_torque:
                Tregen_r = Rear_max_braking_torque - Tmech_r
            
            # Case 2.2: Rear cannot handle regen + mechanical torque
            elif (rear_max_regen + Tmech_r) < Rear_max_braking_torque:
                Tregen_r = rear_max_regen
                Tmech_r = Rear_max_braking_torque - Tregen_r
                Tmech_f = Tmech_r * (Beta / (1 - Beta))
                
                # Case 2.2.1: Front can handle new mechanical torque
                if Front_max_braking_torque >= Tmech_f and (front_max_regen + Tmech_f) >= Front_max_braking_torque:
                    Tregen_f = Front_max_braking_torque - Tmech_f
                
                # Case 2.2.2: Front cannot handle, distribute remaining
                else:
                    Tregen_f = front_max_regen
                    Tregen_r = rear_max_regen
                    Tmech_f = (Tz - Tregen_f - Tregen_r) * Beta
                    Tmech_r = (Tz - Tregen_f - Tregen_r) * (1 - Beta)
        
        # Create MUX output vector: [Tregen_f, Tregen_r, Tmech_f, Tmech_r]
        torque_mux = [Tregen_f, Tregen_r, Tmech_f, Tmech_r]
        
        # Create emergency braking MUX: [0, Tmech_f, 0, Tmech_r]
        emergency_mux = self.create_emergency_mux(Tmech_f, Tmech_r)
        outputs['emergency_mux'] = emergency_mux
        
        # Apply switch logic to select between mux2_output (Case1) and torque_mux (Case2)
        signal_out = self.switch_signal_output(pedal_position, vehicle_velocity_ms, mux_output, torque_mux)
        outputs['signal_out'] = signal_out
        
        # Switch1: Check z_value >= 0.927 to select between emergency_mux or signal_out
        if z_value >= 0.927:
            # Emergency braking mode
            # emergency_mux format: [0, Tmech_f, 0, Tmech_r]
            # Output order: [front_regen, front_mechanical, rear_regen, rear_mechanical]
            final_output = emergency_mux
            outputs['emergency_braking'] = True
            
            outputs['front_regen_torque'] = final_output[0]
            outputs['front_mechanical_torque'] = final_output[1]  # Tmech_f
            outputs['rear_regen_torque'] = final_output[2]
            outputs['rear_mechanical_torque'] = final_output[3]  # Tmech_r
        else:
            # Normal braking mode - use signal_out
            final_output = signal_out
            outputs['emergency_braking'] = False
            
            # Check which format signal_out is using
            if signal_out == mux_output:
                # Light braking mode - mux2_output format: [front_regen, 0, rear_regen, 0]
                outputs['front_regen_torque'] = final_output[0]
                outputs['front_mechanical_torque'] = final_output[1]
                outputs['rear_regen_torque'] = final_output[2]
                outputs['rear_mechanical_torque'] = final_output[3]
            else:
                # Normal braking mode - torque_mux format: [Tregen_f, Tregen_r, Tmech_f, Tmech_r]
                outputs['front_regen_torque'] = final_output[0]
                outputs['rear_regen_torque'] = final_output[1]
                outputs['front_mechanical_torque'] = final_output[2]
                outputs['rear_mechanical_torque'] = final_output[3]
        
        outputs['torque_mux'] = torque_mux  # MUX vector output
        outputs['final_output'] = final_output  # Selected output vector
        
        return outputs
    
    def get_outputs(self,
                    pedal_position,
                    vehicle_velocity_ms,
                    front_motor_angular_velocity,
                    rear_motor_angular_velocity,
                    front_vertical_load,
                    rear_vertical_load,
                    vehicle_acceleration):
        """
        Get all braking system outputs
        
        Args:
            pedal_position: Pedal position (-1 to 0 for braking, 0 to 1 for acceleration)
            vehicle_velocity_ms: Vehicle velocity in m/s
            front_motor_angular_velocity: Front motor angular velocity (rad/s)
            rear_motor_angular_velocity: Rear motor angular velocity (rad/s)
            front_vertical_load: Front axle vertical load (N)
            rear_vertical_load: Rear axle vertical load (N)
            vehicle_acceleration: Current vehicle acceleration (m/s²)
        
        Returns:
            dict: All braking system outputs
        """
        
        outputs = self.calculate_braking_torques(
            pedal_position,
            vehicle_velocity_ms,
            front_motor_angular_velocity,
            rear_motor_angular_velocity,
            front_vertical_load,
            rear_vertical_load,
            vehicle_acceleration
        )
        
        # Add additional calculated values
        outputs['total_braking_torque'] = (
            outputs['front_regen_torque'] + outputs['front_mechanical_torque'] +
            outputs['rear_regen_torque'] + outputs['rear_mechanical_torque']
        )
        
        outputs['total_regen_torque'] = (
            outputs['front_regen_torque'] + outputs['rear_regen_torque']
        )
        
        outputs['total_mechanical_torque'] = (
            outputs['front_mechanical_torque'] + outputs['rear_mechanical_torque']
        )
        
        # Calculate regenerative braking power (kW)
        front_regen_power = outputs['front_regen_torque'] * front_motor_angular_velocity / 1000.0
        rear_regen_power = outputs['rear_regen_torque'] * rear_motor_angular_velocity / 1000.0
        outputs['total_regen_power_kw'] = front_regen_power + rear_regen_power
        
        return outputs


